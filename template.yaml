AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Freelance Job/Task Platform
  
  Unified serverless freelance platform with single API Gateway.

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, prod]
    Description: Environment name

  UsersTableName:
    Type: String
    Default: dev-UsersTable
    Description: Name of the existing Users table

  BackupRetentionDays:
    Type: Number
    Default: 35
    Description: Number of days to retain DynamoDB backups
    MinValue: 1
    MaxValue: 35

  BackupScheduleExpression:
    Type: String
    Default: "cron(0 2 * * ? *)"
    Description: "Schedule expression for Cognito backup job (UTC)"
    AllowedPattern: "^cron\\(.*\\)$"

Globals:
  Function:
    Runtime: java17
    MemorySize: 1024
    Timeout: 30

Resources:
  ## =========================
  ## Freelance Platform API Gateway
  ## =========================
  FreelancePlatformApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub "${Environment}-freelance-platform-api"
      StageName: Prod
      EndpointConfiguration: REGIONAL
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-User-ID,X-User-Email,X-User-Type'"
        AllowOrigin: "'*'"
        MaxAge: "'600'"
        AllowCredentials: false
      BinaryMediaTypes:
        - "*/*"
      TracingEnabled: true
      Variables:
        ENVIRONMENT: !Ref Environment
      Tags:
        Environment: !Ref Environment
        Project: FreelancePlatform

  ## =========================
  ## DynamoDB Tables
  ## =========================
  CategoriesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${Environment}-CategoriesTable"
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: categoryId
          AttributeType: S
        - AttributeName: name
          AttributeType: S
      KeySchema:
        - AttributeName: categoryId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: NameIndex
          KeySchema:
            - AttributeName: name
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: FreelancePlatform
        - Key: Service
          Value: Categories

  JobsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${Environment}-JobsTable"
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: jobId
          AttributeType: S
        - AttributeName: categoryId
          AttributeType: S
        - AttributeName: status
          AttributeType: S
        - AttributeName: ownerId
          AttributeType: S
        - AttributeName: datePosted
          AttributeType: S
        - AttributeName: expiryDate
          AttributeType: S
        - AttributeName: claimerId
          AttributeType: S
        - AttributeName: claimedAt
          AttributeType: S
      KeySchema:
        - AttributeName: jobId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: CategoryStatusIndex
          KeySchema:
            - AttributeName: categoryId
              KeyType: HASH
            - AttributeName: status
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: OwnerJobsIndex
          KeySchema:
            - AttributeName: ownerId
              KeyType: HASH
            - AttributeName: datePosted
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: StatusExpiryIndex
          KeySchema:
            - AttributeName: status
              KeyType: HASH
            - AttributeName: expiryDate
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: ClaimerJobsIndex
          KeySchema:
            - AttributeName: claimerId
              KeyType: HASH
            - AttributeName: claimedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: FreelancePlatform
        - Key: Service
          Value: Jobs

  PaymentRecordsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${Environment}-PaymentRecordsTable"
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: paymentId
          AttributeType: S
        - AttributeName: jobId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
        - AttributeName: paymentDate
          AttributeType: S
      KeySchema:
        - AttributeName: paymentId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: JobIdIndex
          KeySchema:
            - AttributeName: jobId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: UserIdIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: paymentDate
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: FreelancePlatform
        - Key: Service
          Value: Payments

  ClaimsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${Environment}-ClaimsTable"
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: claimId
          AttributeType: S
        - AttributeName: jobId
          AttributeType: S
        - AttributeName: status
          AttributeType: S
        - AttributeName: claimerId
          AttributeType: S
        - AttributeName: claimedAt
          AttributeType: S
        - AttributeName: submissionDeadline
          AttributeType: S
      KeySchema:
        - AttributeName: claimId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: JobClaimsIndex
          KeySchema:
            - AttributeName: jobId
              KeyType: HASH
            - AttributeName: status
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: ClaimerClaimsIndex
          KeySchema:
            - AttributeName: claimerId
              KeyType: HASH
            - AttributeName: claimedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: StatusDeadlineIndex
          KeySchema:
            - AttributeName: status
              KeyType: HASH
            - AttributeName: submissionDeadline
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: FreelancePlatform
        - Key: Service
          Value: Jobs

  ## =========================
  ## DynamoDB Backup Configuration (Single Plan for All Tables)
  ## =========================
  DynamoDBBackupVault:
    Type: AWS::Backup::BackupVault
    Properties:
      BackupVaultName: !Sub "${Environment}-DynamoDB-Backup-Vault"
      BackupVaultTags:
        Environment: !Ref Environment
        Project: FreelancePlatform
        Service: Backup

  DynamoDBBackupPlan:
    Type: AWS::Backup::BackupPlan
    Properties:
      BackupPlan:
        BackupPlanName: !Sub "${Environment}-DynamoDB-Backup-Plan"
        BackupPlanRule:
          - RuleName: DailyBackupRule
            TargetBackupVault: !Ref DynamoDBBackupVault
            ScheduleExpression: "cron(0 5 * * ? *)" # Daily at 5 AM UTC
            StartWindowMinutes: 60
            CompletionWindowMinutes: 180
            Lifecycle:
              DeleteAfterDays: !Ref BackupRetentionDays
            EnableContinuousBackup: true

  BackupServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: backup.amazonaws.com
            Action: sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: DynamoDBBackupAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:DescribeTable
                  - dynamodb:ListTagsOfResource
                Resource: "*"
              - Effect: Allow
                Action:
                  - backup:StartBackupJob
                  - backup:GetBackupVaultAccessPolicy
                  - backup:PutBackupVaultAccessPolicy
                Resource: "*"

  ## =========================
  ## Cognito User Pool Backup System
  ## =========================
  CognitoBackupUserPoolTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${Environment}-CognitoBackupUserPool"
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: email
          AttributeType: S
        - AttributeName: backupTimestamp
          AttributeType: N
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: backupTimestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: EmailIndex
          KeySchema:
            - AttributeName: email
              KeyType: HASH
            - AttributeName: backupTimestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: FreelancePlatform
        - Key: Service
          Value: CognitoBackup

  CognitoBackupUserPoolSecondaryTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${Environment}-CognitoBackupUserPool-Secondary"
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: email
          AttributeType: S
        - AttributeName: backupTimestamp
          AttributeType: N
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: backupTimestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: EmailIndex
          KeySchema:
            - AttributeName: email
              KeyType: HASH
            - AttributeName: backupTimestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: FreelancePlatform
        - Key: Service
          Value: CognitoBackup

  #### CognitoBackup
  CognitoBackupFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-CognitoBackupFunction"
      CodeUri: cognito-backup/
      Handler: com.freelance.cognito.backup.CognitoBackupHandler::handleRequest
      Timeout: 300
      Environment:
        Variables:
          PRIMARY_BACKUP_TABLE: !Ref CognitoBackupUserPoolTable
          SECONDARY_BACKUP_TABLE: !Ref CognitoBackupUserPoolSecondaryTable
          USER_POOL_ID: !Ref UserPool
          BACKUP_TTL_DAYS: "90"
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - cognito-idp:ListUsers
              Resource: !GetAtt UserPool.Arn
            - Effect: Allow
              Action:
                - dynamodb:BatchWriteItem
                - dynamodb:PutItem
              Resource:
                - !GetAtt CognitoBackupUserPoolTable.Arn
                - !GetAtt CognitoBackupUserPoolSecondaryTable.Arn
      Events:
        BackupSchedule:
          Type: Schedule
          Properties:
            Schedule: !Ref BackupScheduleExpression
            Name: !Sub "${Environment}-CognitoBackupSchedule"
            Description: "Periodic backup of Cognito User Pool data to DynamoDB"
            Enabled: true

  ## =========================
  ## EventBridge Resources
  ## =========================
  JobsEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Sub "${Environment}-freelance-jobs-events"

  ## =========================
  ## SNS Topic for Notifications
  ## =========================
  JobNotificationsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "${Environment}-job-notifications"
      DisplayName: "Job Platform Notifications"

  ## =========================
  ## Job Expiry System
  ## =========================
  JobExpiryQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${Environment}-job-expiry-queue.fifo"
      FifoQueue: true
      ContentBasedDeduplication: false
      MessageRetentionPeriod: 1209600  # 14 days
      VisibilityTimeout: 300    # 5 minutes
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt JobExpiryDeadLetterQueue.Arn
        maxReceiveCount: 3

  JobExpiryDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${Environment}-job-expiry-dlq.fifo"
      FifoQueue: true
      MessageRetentionPeriod: 1209600  # 14 days

  ## =========================
  ## Job Timeout System
  ## =========================
  JobTimeoutQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${Environment}-job-timeout-queue.fifo"
      FifoQueue: true
      ContentBasedDeduplication: false
      MessageRetentionPeriod: 1209600  # 14 days
      VisibilityTimeout: 300    # 5 minutes
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt JobTimeoutDeadLetterQueue.Arn
        maxReceiveCount: 3

  JobTimeoutDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${Environment}-job-timeout-dlq.fifo"
      FifoQueue: true
      MessageRetentionPeriod: 1209600  # 14 days


  #### Payment Processing Lambda Function
  PaymentProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-PaymentProcessor"
      CodeUri: payment/
      Handler: com.freelance.payment.PaymentProcessorHandler::handleRequest
      Runtime: java17
      Timeout: 60
      MemorySize: 512
      Environment:
        Variables:
          PAYMENT_RECORDS_TABLE: !Ref PaymentRecordsTable
          ACCOUNTS_TABLE: !Ref AccountsTable
      Policies:
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:PutItem
                - dynamodb:UpdateItem
                - dynamodb:GetItem
              Resource:
                - !GetAtt PaymentRecordsTable.Arn
                - !GetAtt AccountsTable.Arn
      Events:
        PaymentTrigger:
          Type: CloudWatchEvent
          Properties:
            EventBusName: !Ref JobsEventBus
            Pattern:
              source: [ "jobs-service" ]
              detail-type: [ "job.approved" ]


  ## =========================
  ## Categories Lambda Functions
  ## =========================
  CreateCategoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-CreateCategory"
      CodeUri: categories/
      Handler: com.freelance.categories.CreateCategoryHandler::handleRequest
      Environment:
        Variables:
          CATEGORIES_TABLE_NAME: !Ref CategoriesTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref CategoriesTable
      Events:
        CreateCategoryApi:
          Type: Api
          Properties:
            RestApiId: !Ref FreelancePlatformApi
            Path: /categories
            Method: post

  GetCategoriesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-GetCategories"
      CodeUri: categories/
      Handler: com.freelance.categories.GetCategoriesHandler::handleRequest
      Environment:
        Variables:
          CATEGORIES_TABLE_NAME: !Ref CategoriesTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref CategoriesTable
      Events:
        GetCategoriesApi:
          Type: Api
          Properties:
            RestApiId: !Ref FreelancePlatformApi
            Path: /categories
            Method: get

  CategoryStreamProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-CategoryStreamProcessor"
      CodeUri: categories/
      Handler: com.freelance.categories.CategoryStreamProcessor::handleRequest
      Environment:
        Variables:
          CATEGORIES_TABLE_NAME: !Ref CategoriesTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref CategoriesTable
        - Statement:
            - Effect: Allow
              Action:
                - sns:CreateTopic
                - sns:GetTopicAttributes
              Resource: "*"
      Events:
        CategoryStreamEvent:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt CategoriesTable.StreamArn
            StartingPosition: TRIM_HORIZON
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 5

  ## =========================
  ## Jobs Lambda Functions
  ## =========================
  JobRouterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-JobRouter"
      CodeUri: jobs/
      Handler: com.freelance.jobs.shared.JobRouter::handleRequest
      Timeout: 60
      Environment:
        Variables:
          JOBS_TABLE_NAME: !Ref JobsTable
          CATEGORIES_TABLE_NAME: !Ref CategoriesTable
          EVENT_BUS_NAME: !Ref JobsEventBus
          AWS_ACCOUNT_ID: !Ref AWS::AccountId
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable
        - DynamoDBReadPolicy:
            TableName: !Ref CategoriesTable
        - Statement:
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !GetAtt JobsEventBus.Arn
      Events:
        JobApi:
          Type: Api
          Properties:
            RestApiId: !Ref FreelancePlatformApi
            Path: /job/{proxy+}
            Method: ANY

  HealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-HealthCheck"
      CodeUri: health/
      Handler: com.freelance.health.HealthCheckHandler::handleRequest
      Runtime: java17
      MemorySize: 512
      Timeout: 30
      Events:
        HealthCheckApi:
          Type: Api
          Properties:
            RestApiId: !Ref FreelancePlatformApi
            Path: /health
            Method: GET

  ## =========================
  ## Event Processor Functions
  ## =========================
  JobCreatedProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-JobCreatedProcessor"
      CodeUri: jobs/
      Handler: com.freelance.jobs.events.processors.NotifyJobCategorySubscribersHandler::handleRequest
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - sns:Publish
              Resource: "*"
      Events:
        JobCreatedEvent:
          Type: CloudWatchEvent
          Properties:
            EventBusName: !Ref JobsEventBus
            Pattern:
              source: ["jobs-service"]
              detail-type: ["job.created"]

  ## Job Notification Handler
  JobNotificationHandler:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-JobNotificationHandler"
      CodeUri: jobs/
      Handler: com.freelance.jobs.notifications.JobNotificationHandler::handleRequest
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          FROM_EMAIL_ADDRESS: "noreply@freelanceplatform.com"
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${UsersTableName}"
      Events:
        NotificationTopic:
          Type: SNS
          Properties:
            Topic: !Ref JobNotificationsTopic

  ###### Payment Notification Handler
  PaymentNotificationHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-PaymentNotificationHandler"
      CodeUri: payment/
      Handler: com.freelance.payment.notifications.PaymentNotificationHandler::handleRequest
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref UsersTableName
          FROM_EMAIL_ADDRESS: "noreply@freelanceplatform.com"
          NOTIFICATION_TOPIC_ARN: !Ref JobNotificationsTopic
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: "*"
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${UsersTableName}"
        - Statement:
            - Effect: Allow
              Action:
                - sns:Publish
              Resource: !Ref JobNotificationsTopic
      Events:
        PaymentNotificationTopic:
          Type: SNS
          Properties:
            Topic: !Ref JobNotificationsTopic

  ## Event Processors - Forward to Centralized Topic
  JobClaimedProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-JobClaimedProcessor"
      CodeUri: jobs/
      Handler: com.freelance.jobs.events.processors.JobClaimedProcessor::handleRequest
      Environment:
        Variables:
          NOTIFICATION_TOPIC_ARN: !Ref JobNotificationsTopic
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - sns:Publish
              Resource: !Ref JobNotificationsTopic
      Events:
        JobClaimedEvent:
          Type: CloudWatchEvent
          Properties:
            EventBusName: !Ref JobsEventBus
            Pattern:
              source: ["jobs-service"]
              detail-type: ["job.claimed"]

  JobSubmittedProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-JobSubmittedProcessor"
      CodeUri: jobs/
      Handler: com.freelance.jobs.events.processors.JobSubmittedProcessor::handleRequest
      Environment:
        Variables:
          NOTIFICATION_TOPIC_ARN: !Ref JobNotificationsTopic
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - sns:Publish
              Resource: !Ref JobNotificationsTopic
      Events:
        JobSubmittedEvent:
          Type: CloudWatchEvent
          Properties:
            EventBusName: !Ref JobsEventBus
            Pattern:
              source: ["jobs-service"]
              detail-type: ["job.submitted"]

  JobApprovedProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-JobApprovedProcessor"
      CodeUri: jobs/
      Handler: com.freelance.jobs.events.processors.JobApprovedProcessor::handleRequest
      Environment:
        Variables:
          NOTIFICATION_TOPIC_ARN: !Ref JobNotificationsTopic
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - sns:Publish
              Resource: !Ref JobNotificationsTopic
      Events:
        JobApprovedEvent:
          Type: CloudWatchEvent
          Properties:
            EventBusName: !Ref JobsEventBus
            Pattern:
              source: ["jobs-service"]
              detail-type: ["job.approved"]

  JobRejectedProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-JobRejectedProcessor"
      CodeUri: jobs/
      Handler: com.freelance.jobs.events.processors.JobRejectedProcessor::handleRequest
      Environment:
        Variables:
          NOTIFICATION_TOPIC_ARN: !Ref JobNotificationsTopic
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - sns:Publish
              Resource: !Ref JobNotificationsTopic
      Events:
        JobRejectedEvent:
          Type: CloudWatchEvent
          Properties:
            EventBusName: !Ref JobsEventBus
            Pattern:
              source: ["jobs-service"]
              detail-type: ["job.rejected"]

  ## =========================
  ## Scheduler Functions
  ## =========================
  JobExpiryScannerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-JobExpiryScanner"
      CodeUri: jobs/
      Handler: com.freelance.jobs.schedulers.JobExpiryScanner::handleRequest
      Timeout: 300  # 5 minutes
      Environment:
        Variables:
          JOBS_TABLE_NAME: !Ref JobsTable
          JOB_EXPIRY_QUEUE_URL: !Ref JobExpiryQueue
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable
        - Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource: !GetAtt JobExpiryQueue.Arn
      Events:
        ExpirySchedule:
          Type: Schedule
          Properties:
            Schedule: "rate(5 minutes)"
            Description: "Trigger job expiry scanner every 5 minutes"

  JobExpiryProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-JobExpiryProcessor"
      CodeUri: jobs/
      Handler: com.freelance.jobs.schedulers.processors.JobExpiryProcessor::handleRequest
      Timeout: 60
      Environment:
        Variables:
          NOTIFICATION_TOPIC_ARN: !Ref JobNotificationsTopic
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - sns:Publish
              Resource: !Ref JobNotificationsTopic
      Events:
        ExpiryQueue:
          Type: SQS
          Properties:
            Queue: !GetAtt JobExpiryQueue.Arn
            BatchSize: 10

  JobTimeoutScannerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-JobTimeoutScanner"
      CodeUri: jobs/
      Handler: com.freelance.jobs.schedulers.JobTimeoutScanner::handleRequest
      Timeout: 300
      Environment:
        Variables:
          JOBS_TABLE_NAME: !Ref JobsTable
          JOB_TIMEOUT_QUEUE_URL: !Ref JobTimeoutQueue
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable
        - Statement:
            - Effect: Allow
              Action:
                - sqs:SendMessage
              Resource: !GetAtt JobTimeoutQueue.Arn
      Events:
        TimeoutSchedule:
          Type: Schedule
          Properties:
            Schedule: "rate(2 minutes)"
            Description: "Trigger job timeout scanner every 2 minutes"

  JobTimeoutProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-JobTimeoutProcessor"
      CodeUri: jobs/
      Handler: com.freelance.jobs.schedulers.processors.JobTimeoutProcessor::handleRequest
      Timeout: 60
      Environment:
        Variables:
          NOTIFICATION_TOPIC_ARN: !Ref JobNotificationsTopic
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - sns:Publish
              Resource: !Ref JobNotificationsTopic
      Events:
        TimeoutQueue:
          Type: SQS
          Properties:
            Queue: !GetAtt JobTimeoutQueue.Arn
            BatchSize: 10

  ###################################
  # DynamoDB Tables
  ###################################
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "UsersTable-${Environment}"
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: EmailIndex
          KeySchema:
            - AttributeName: email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: FreelancePlatform

  AccountsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "AccountsTable-${Environment}"
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: accountNumber
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
        - IndexName: AccountNumberIndex
          KeySchema:
            - AttributeName: accountNumber
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: FreelancePlatform

  ###################################
  # SNS Topic for Job Alerts
  ###################################
  JobAlertsTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub "JobAlertsTopic-${Environment}"

  ###################################
  # Cognito User Pool, Groups(Roles) and Client
  ###################################
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub "FreelancePlatformUserPool-${Environment}"
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      LambdaConfig:
        PostConfirmation: !GetAtt PostConfirmationLambda.Arn
      Schema:
        - Name: email
          AttributeDataType: String
          Mutable: false
          Required: true
        - Name: given_name
          AttributeDataType: String
          Mutable: true
          Required: true
        - Name: family_name
          AttributeDataType: String
          Mutable: true
          Required: true
        - Name: middle_name
          AttributeDataType: String
          Mutable: true
        - Name: job_category_ids
          AttributeDataType: String
          Mutable: true
        - Name: phone_number
          AttributeDataType: String
          Mutable: true

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub "FreelancePlatformUserPoolClient-${Environment}"
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH
      SupportedIdentityProviders:
        - COGNITO
      PreventUserExistenceErrors: ENABLED
      CallbackURLs:
        - https://www.example.com/callback   # for local testing
      LogoutURLs:
        - https://www.example.com/logout     # for local testing
      AllowedOAuthFlows:
        - code
        - implicit
      AllowedOAuthScopes:
        - email
        - openid
        - profile
      AllowedOAuthFlowsUserPoolClient: true

  UserGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: USER
      Precedence: 2
      UserPoolId: !Ref UserPool
      Description: "Regular users of the platform"

  AdminGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: ADMIN
      Precedence: 1
      UserPoolId: !Ref UserPool
      Description: "Platform administrators"

  UserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      Domain: !Sub "freelance-platform-${Environment}-${AWS::AccountId}"
      UserPoolId: !Ref UserPool

  ###################################
  # Lambda Functions
  ###################################
  PostConfirmationLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "PostConfirmationLambda-${Environment}"
      CodeUri: authentication/
      Handler: com.freelanceplatform.handlers.users.PostConfirmationHandler::handleRequest
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - states:StartExecution
              Resource: !Ref UserOnboardingStateMachine
            - Effect: Allow
              Action:
                - cognito-idp:AdminAddUserToGroup
              Resource: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*"
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: "*"
      Environment:
        Variables:
          STATE_MACHINE_ARN: !Ref UserOnboardingStateMachine
          ENVIRONMENT: !Ref Environment

  # Allow Cognito to invoke PostConfirmation Lambda
  LambdaPermissionForCognito:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt PostConfirmationLambda.Arn
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !GetAtt UserPool.Arn

  GenerateUserIdLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "GenerateUserIdLambda-${Environment}"
      CodeUri: authentication/
      Handler: com.freelanceplatform.handlers.users.GenerateUserIdHandler::handleRequest
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment

  SaveUserDataLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "SaveUserDataLambda-${Environment}"
      CodeUri: authentication/
      Handler: com.freelanceplatform.handlers.users.SaveUserDataHandler::handleRequest
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
      Environment:
        Variables:
          USERS_TABLE: !Ref UsersTable
          ENVIRONMENT: !Ref Environment

  CreateAccountLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "CreateAccountLambda-${Environment}"
      CodeUri: authentication/
      Handler: com.freelanceplatform.handlers.users.CreateAccountHandler::handleRequest
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref AccountsTable
      Environment:
        Variables:
          ACCOUNTS_TABLE: !Ref AccountsTable
          ENVIRONMENT: !Ref Environment

  SubscribeUserToSNSLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "SubscribeUserToSNSLambda-${Environment}"
      CodeUri: authentication/
      Handler: com.freelanceplatform.handlers.users.SubscribeUserToSNSHandler::handleRequest
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - sns:Subscribe
                - sns:SetSubscriptionAttributes
              Resource: !Ref JobAlertsTopic
      Environment:
        Variables:
          SNS_TOPIC_ARN: !Ref JobAlertsTopic
          ENVIRONMENT: !Ref Environment

  DeleteUserHandler:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "DeleteUserHandler-${Environment}"
      CodeUri: authentication/
      Handler: com.freelanceplatform.handlers.users.DeleteUserHandler::handleRequest
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AccountsTable
      Environment:
        Variables:
          USERS_TABLE: !Ref UsersTable
          ACCOUNTS_TABLE: !Ref AccountsTable
          ENVIRONMENT: !Ref Environment

  ###################################
  # Step Functions
  ###################################
  UserOnboardingStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub "UserOnboardingWorkflow-${Environment}"
      Definition:
        Comment: "User onboarding after Cognito signup"
        StartAt: GenerateUserId
        States:
          GenerateUserId:
            Type: Task
            Resource: !GetAtt GenerateUserIdLambda.Arn
            Next: SaveUserData
          SaveUserData:
            Type: Task
            Resource: !GetAtt SaveUserDataLambda.Arn
            Next: CreateAccount
          CreateAccount:
            Type: Task
            Resource: !GetAtt CreateAccountLambda.Arn
            Next: SubscribeUserToSNS
          SubscribeUserToSNS:
            Type: Task
            Resource: !GetAtt SubscribeUserToSNSLambda.Arn
            End: true
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref GenerateUserIdLambda
        - LambdaInvokePolicy:
            FunctionName: !Ref SaveUserDataLambda
        - LambdaInvokePolicy:
            FunctionName: !Ref CreateAccountLambda
        - LambdaInvokePolicy:
            FunctionName: !Ref SubscribeUserToSNSLambda

  UserDeletionCleanupStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub "UserDeletionCleanupWorkflow-${Environment}"
      Definition:
        Comment: "User deletion cleanup after Cognito user removal"
        StartAt: DeleteUserDataAndAccount
        States:
          DeleteUserDataAndAccount:
            Type: Task
            Resource: !GetAtt DeleteUserHandler.Arn
            End: true
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref DeleteUserHandler

  ###################################
  # EventBridge Rule for User Deletion Detection
  ###################################
  UserDeletionEventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: "Trigger cleanup Step Function on Cognito user deletion"
      EventPattern:
        source:
          - aws.cognito-idp
        detail-type:
          - AWS API Call via CloudTrail
        detail:
          eventName:
            - AdminDeleteUser
            - DeleteUser
      Targets:
        - Arn: !Ref UserDeletionCleanupStateMachine
          Id: "UserDeletionStepFunctionTarget"
          RoleArn: !GetAtt EventBridgeInvokeStepFunctionRole.Arn

  EventBridgeInvokeStepFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InvokeStepFunctionPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - states:StartExecution
                Resource:
                  - !Ref UserDeletionCleanupStateMachine
                  - !Ref UserOnboardingStateMachine

  ## =========================
  ## DynamoDB Backup Selection
  ## =========================
  DynamoDBBackupSelection:
    Type: AWS::Backup::BackupSelection
    Properties:
      BackupPlanId: !Ref DynamoDBBackupPlan
      BackupSelection:
        SelectionName: !Sub "${Environment}-DynamoDB-Tables"
        IamRoleArn: !GetAtt BackupServiceRole.Arn
        Resources:
          - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${CategoriesTable}"
          - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${JobsTable}"
          - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ClaimsTable}"
          - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${UsersTable}"
          - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${AccountsTable}"
          - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${PaymentRecordsTable}"
          - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${CognitoBackupUserPoolTable}"
          - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${CognitoBackupUserPoolSecondaryTable}"

  JobAdminRouterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Environment}-JobAdminRouter"
      CodeUri: admin/
      Handler: com.freelance.admin.shared.JobAdminRouter::handleRequest
      Timeout: 60
      Environment:
        Variables:
          JOBS_TABLE_NAME: !Ref JobsTable
          CATEGORIES_TABLE_NAME: !Ref CategoriesTable
          EVENT_BUS_NAME: !Ref JobsEventBus
          AWS_ACCOUNT_ID: !Ref AWS::AccountId
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref JobsTable
        - DynamoDBReadPolicy:
            TableName: !Ref CategoriesTable
        - Statement:
            - Effect: Allow
              Action:
                - events:PutEvents
              Resource: !GetAtt JobsEventBus.Arn
            - Effect: Allow
              Action:
                - cognito-idp:AdminListGroupsForUser
              Resource: !GetAtt UserPool.Arn
      Events:
        AdminApi:
          Type: Api
          Properties:
            RestApiId: !Ref FreelancePlatformApi
            Path: /admin/job/{proxy+}
            Method: ANY


Outputs:
  ## Unified API Gateway Output
  FreelancePlatformApiUrl:
    Description: "Unified Freelance Platform API URL"
    Value: !Sub "https://${FreelancePlatformApi}.execute-api.${AWS::Region}.amazonaws.com/Prod"
    Export:
      Name: !Sub "${Environment}-freelance-api-url"

  HealthCheckUrl:
    Description: "Health check endpoint URL"
    Value: !Sub "https://${FreelancePlatformApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/health"
    Export:
      Name: !Sub "${Environment}-health-check-url"

  FreelancePlatformApiId:
    Description: "API Gateway ID"
    Value: !Ref FreelancePlatformApi
    Export:
      Name: !Sub "${Environment}-freelance-api-id"

  ## Table Outputs
  CategoriesTableName:
    Description: "Categories DynamoDB Table Name"
    Value: !Ref CategoriesTable
    Export:
      Name: !Sub "${Environment}-categories-table-name"

  CategoriesTableArn:
    Description: "Categories DynamoDB Table ARN"
    Value: !GetAtt CategoriesTable.Arn
    Export:
      Name: !Sub "${Environment}-categories-table-arn"

  JobsTableName:
    Description: "Jobs DynamoDB Table Name"
    Value: !Ref JobsTable
    Export:
      Name: !Sub "${Environment}-jobs-table-name"

  JobsTableArn:
    Description: "Jobs DynamoDB Table ARN"
    Value: !GetAtt JobsTable.Arn
    Export:
      Name: !Sub "${Environment}-jobs-table-arn"

  PaymentRecordsTableName:
    Description: "Payment Records DynamoDB Table Name"
    Value: !Ref PaymentRecordsTable
    Export:
      Name: !Sub "${Environment}-payment-records-table-name"

  PaymentRecordsTableArn:
    Description: "Payment Records DynamoDB Table ARN"
    Value: !GetAtt PaymentRecordsTable.Arn
    Export:
      Name: !Sub "${Environment}-payment-records-table-arn"

  ClaimsTableName:
    Description: "Claims DynamoDB Table Name"
    Value: !Ref ClaimsTable
    Export:
      Name: !Sub "${Environment}-claims-table-name"

  UsersTableName:
    Description: "Users DynamoDB Table Name"
    Value: !Ref UsersTableName

  ## EventBridge Outputs
  JobsEventBusName:
    Description: "EventBridge Custom Bus for Jobs Events"
    Value: !Ref JobsEventBus
    Export:
      Name: !Sub "${Environment}-jobs-event-bus-name"

  JobsEventBusArn:
    Description: "EventBridge Custom Bus ARN for Jobs Events"
    Value: !GetAtt JobsEventBus.Arn
    Export:
      Name: !Sub "${Environment}-jobs-event-bus-arn"

  ## Notification System Outputs
  JobNotificationsTopicArn:
    Description: "Centralized Job Notifications SNS Topic ARN"
    Value: !Ref JobNotificationsTopic
    Export:
      Name: !Sub "${Environment}-job-notifications-topic-arn"

  ## Job Management System Outputs
  JobExpiryQueueUrl:
    Description: "SQS Queue URL for Job Expiry Processing"
    Value: !Ref JobExpiryQueue
    Export:
      Name: !Sub "${Environment}-job-expiry-queue-url"

  JobTimeoutQueueUrl:
    Description: "SQS Queue URL for Job Timeout Processing"
    Value: !Ref JobTimeoutQueue
    Export:
      Name: !Sub "${Environment}-job-timeout-queue-url"

  ## User Management Outputs
  UserPoolId:
    Description: "Cognito User Pool Id"
    Value: !Ref UserPool
    Export:
      Name: !Sub "FreelancePlatform-UserPoolId-${Environment}"

  UserPoolClientId:
    Description: "Cognito User Pool Client Id"
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub "FreelancePlatform-UserPoolClientId-${Environment}"

  UserOnboardingStateMachineArn:
    Description: "ARN of User Onboarding Step Function"
    Value: !Ref UserOnboardingStateMachine
    Export:
      Name: !Sub "FreelancePlatform-UserOnboardingSFNArn-${Environment}"

  UserDeletionCleanupStateMachineArn:
    Description: "ARN of User Deletion Cleanup Step Function"
    Value: !Ref UserDeletionCleanupStateMachine
    Export:
      Name: !Sub "FreelancePlatform-UserDeletionCleanupSFNArn-${Environment}"

  CognitoHostedUiUrl:
    Description: "Cognito Hosted UI Login URL"
    Value: !Sub "https://${UserPoolDomain}.auth.${AWS::Region}.amazoncognito.com/login?client_id=${UserPoolClient}&response_type=token&scope=email+openid+profile&redirect_uri=https://www.example.com/callback"
    Export:
      Name: !Sub "FreelancePlatform-HostedUiUrl-${Environment}"

  ## Backup System Outputs
  DynamoDBBackupVaultName:
    Description: "DynamoDB Backup Vault Name"
    Value: !Ref DynamoDBBackupVault
    Export:
      Name: !Sub "${Environment}-dynamodb-backup-vault"

  DynamoDBBackupPlanName:
    Description: "DynamoDB Backup Plan Name"
    Value: !Ref DynamoDBBackupPlan
    Export:
      Name: !Sub "${Environment}-dynamodb-backup-plan"

  CognitoBackupPrimaryTableName:
    Description: "Primary Cognito User Pool Backup Table"
    Value: !Ref CognitoBackupUserPoolTable
    Export:
      Name: !Sub "${Environment}-cognito-backup-primary-table"

  CognitoBackupSecondaryTableName:
    Description: "Secondary Cognito User Pool Backup Table"
    Value: !Ref CognitoBackupUserPoolSecondaryTable
    Export:
      Name: !Sub "${Environment}-cognito-backup-secondary-table"

  CognitoBackupFunctionName:
    Description: "Cognito Backup Lambda Function Name"
    Value: !Ref CognitoBackupFunction
    Export:
      Name: !Sub "${Environment}-cognito-backup-function"